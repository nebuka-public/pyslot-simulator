<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>パチスロ筐体 ハードウェア抽象ブロック図</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #1e1f26;
    --panel: #2a2d37;
    --text: #f5f7fa;
    --accent: #ffcc00;
    --border: #4a4f5e;
    --motor: #2b6cb0;
    --sensor: #3182ce;
    --core: #b7791f;
    --rng: #2f855a;
    --mem: #276749;
    --sec: #c53030;
    --out: #805ad5;
    --payout: #d69e2e;
    --power: #718096;
  }
  body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,BlinkMacSystemFont,"Helvetica Neue","Segoe UI",sans-serif; margin:0; }
  header { padding: 16px 24px; background: #14151a; border-bottom: 1px solid var(--border); }
  h1 { margin:0; font-size: 1.4rem; letter-spacing: .05em; }
  main { padding: 16px 24px 80px; }
  #diagram { position: relative; width: 100%; max-width: 1200px; margin: 0 auto; min-height: 720px; }
  .node { position: absolute; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 12px; line-height: 1.3; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,.4); transition: box-shadow .2s, transform .2s; }
  .node:hover { box-shadow: 0 6px 16px rgba(0,0,0,.6); transform: translateY(-2px); }
  .node.core { border-color: var(--core); }
  .node.rng { border-color: var(--rng); }
  .node.mem { border-color: var(--mem); }
  .node.timer { border-color: var(--mem); }
  .node.sec { border-color: var(--sec); }
  .node.motor { border-color: var(--motor); }
  .node.sensor { border-color: var(--sensor); }
  .node.input { border-color: var(--motor); }
  .node.output { border-color: var(--out); }
  .node.payout { border-color: var(--payout); }
  .node.power { border-color: var(--power); }
  .group-label { position:absolute; font-size:11px; font-weight:600; letter-spacing:.08em; text-transform:uppercase; color:#9fa6b2; }
  #diagram svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  line, path { stroke:#778899; stroke-width:1.4; marker-end:url(#arrow); }
  line.highlight, path.highlight { stroke: var(--accent); stroke-width:2.2; }
  #sidepanel { position:fixed; top:0; right:0; width:300px; height:100%; background:#121316; border-left:1px solid var(--border); display:flex; flex-direction:column; }
  #details { padding:16px; overflow-y:auto; flex:1; }
  #details h2 { margin-top:0; font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:4px; }
  #details code { background:#22242c; padding:2px 4px; border-radius:4px; font-size:11px; }
  footer { position:fixed; bottom:0; left:0; right:300px; padding:6px 12px; font-size:11px; background:#14151a; border-top:1px solid var(--border); color:#9fa6b2; }
  .legend { display:flex; flex-wrap:wrap; gap:4px; margin-top:8px; }
  .legend span { display:inline-flex; align-items:center; gap:4px; font-size:10px; background:#22242c; padding:4px 6px; border-radius:4px; border:1px solid #2f333d; }
  .legend i { width:12px; height:12px; display:inline-block; border-radius:3px; }
</style>
</head>
<body>
  <header>
    <h1>パチスロ筐体 ハードウェア抽象ブロック図 (HTML版)</h1>
  </header>
  <main>
    <div id="diagram">
      <svg id="wires"></svg>
    </div>
    <div id="sidepanel">
      <div id="details">
        <h2>詳細</h2>
        <p>ノードをクリックすると詳細説明と想定APIが表示されます。</p>
        <div class="legend" id="legend"></div>
        <section id="info"></section>
      </div>
    </div>
  </main>
  <footer>クリックで接続ハイライト / Escで解除 / 本図は抽象化された構成であり実機の機密仕様は含みません。</footer>

  <!-- wires svg moved inside diagram for proper relative positioning -->

<script>
// ノード定義
const nodes = [
  { id:'MCU', label:'メインCPU/MCU\nゲーム制御/抽選', type:'core', x:480, y:220, w:150, h:70, api:['spin()', 'settle()', 'checkBonus()', 'handleInput()'] },
  { id:'RNG', label:'RNG Engine\n擬似乱数', type:'rng', x:320, y:120, w:120, h:54, api:['nextUint32()', 'uniform()', 'weighted()'] },
  { id:'MEM', label:'Memory Store\nROM/RAM/EEPROM', type:'mem', x:640, y:120, w:140, h:54, api:['readStats()', 'writeStats()', 'loadConfig()'] },
  { id:'TIMER', label:'System Timer\n割り込み/スケジュール', type:'timer', x:320, y:320, w:140, h:54, api:['now()', 'schedule()', 'tickHandler()'] },
  { id:'SEC', label:'Security Module\nドア/電圧/基板ID', type:'sec', x:640, y:320, w:150, h:54, api:['doorState()', 'voltageOk()', 'boardId()', 'logEvent()'] },

  // Reel subsystem
  { id:'RM1', label:'Reel Motor 1', type:'motor', x:80, y:120, w:120, h:40, api:['start()', 'stop()', 'setSpeed()'] },
  { id:'RS1', label:'Reel Sensor 1', type:'sensor', x:80, y:170, w:120, h:40, api:['getIndex()', 'zeroed()'] },
  { id:'RM2', label:'Reel Motor 2', type:'motor', x:80, y:250, w:120, h:40, api:['start()', 'stop()', 'setSpeed()'] },
  { id:'RS2', label:'Reel Sensor 2', type:'sensor', x:80, y:300, w:120, h:40, api:['getIndex()', 'zeroed()'] },
  { id:'RM3', label:'Reel Motor 3', type:'motor', x:80, y:380, w:120, h:40, api:['start()', 'stop()', 'setSpeed()'] },
  { id:'RS3', label:'Reel Sensor 3', type:'sensor', x:80, y:430, w:120, h:40, api:['getIndex()', 'zeroed()'] },

  // Input panel
  { id:'Lever', label:'スタートレバー', type:'input', x:320, y:40, w:120, h:40, api:['leverPulled()'] },
  { id:'Bet', label:'Bet/MaxBet ボタン', type:'input', x:480, y:40, w:150, h:40, api:['betPressed()', 'maxBetPressed()'] },
  { id:'Stops', label:'リール停止ボタン群', type:'input', x:660, y:40, w:150, h:40, api:['stopPressed(reel)'] },
  { id:'SettingKey', label:'設定キー', type:'input', x:840, y:40, w:120, h:40, api:['keyInserted()', 'keyRemoved()'] },

  // Outputs
  { id:'GOGO', label:'GOGO! ランプ', type:'output', x:840, y:160, w:120, h:40, api:['set(on)', 'blink(pattern)'] },
  { id:'PanelLED', label:'パネルLED/表示', type:'output', x:840, y:220, w:140, h:40, api:['display(msg)', 'pattern(id)'] },
  { id:'Audio', label:'サウンド回路', type:'output', x:840, y:280, w:120, h:40, api:['play(id)', 'stopAll()'] },
  { id:'ReelLamp', label:'リール照明', type:'output', x:840, y:340, w:120, h:40, api:['setBrightness(v)', 'pulse()'] },

  // Payout
  { id:'Hopper', label:'ホッパーモータ', type:'payout', x:480, y:420, w:140, h:50, api:['payout(target)', 'stop()', 'status()'] },
  { id:'CoinSensor', label:'コインセンサー', type:'payout', x:640, y:420, w:140, h:50, api:['count()', 'jamDetected()'] },

  // Power
  { id:'PSU', label:'電源基板', type:'power', x:320, y:460, w:120, h:46, api:['voltageLines()', 'faultState()'] },
  { id:'VoltMon', label:'電圧モニタ', type:'power', x:320, y:520, w:120, h:46, api:['isStable()', 'lastDrop()'] }
];

// 接続線定義 (from -> to)
const links = [
  ['MCU','RNG'], ['MCU','MEM'], ['MCU','TIMER'], ['MCU','SEC'],
  ['MCU','Hopper'], ['MCU','CoinSensor'], ['MCU','GOGO'], ['MCU','PanelLED'], ['MCU','Audio'], ['MCU','ReelLamp'],
  ['MCU','RM1'], ['MCU','RM2'], ['MCU','RM3'], ['RM1','RS1'], ['RM2','RS2'], ['RM3','RS3'],
  ['MCU','Lever'], ['MCU','Bet'], ['MCU','Stops'], ['MCU','SettingKey'],
  ['MCU','PSU'], ['PSU','VoltMon'], ['VoltMon','SEC'], ['SEC','MCU']
];

const typeColors = {
  core:'var(--core)', rng:'var(--rng)', mem:'var(--mem)', timer:'var(--mem)', sec:'var(--sec)', motor:'var(--motor)', sensor:'var(--sensor)', input:'var(--motor)', output:'var(--out)', payout:'var(--payout)', power:'var(--power)'
};

function init() {
  const diagram = document.getElementById('diagram');
  nodes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'node ' + n.type;
    div.style.left = n.x + 'px';
    div.style.top = n.y + 'px';
    div.style.width = n.w + 'px';
    div.style.height = n.h + 'px';
    div.innerHTML = n.label.replace(/\n/g,'<br/>');
    div.dataset.id = n.id;
    div.onclick = () => selectNode(n.id);
    diagram.appendChild(div);
  });
  drawLinks();
  buildLegend();
  document.addEventListener('keydown', e => { if(e.key==='Escape') clearHighlight(); });
}

function drawLinks() {
  const svg = document.getElementById('wires');
  svg.innerHTML = '<defs><marker id="arrow" viewBox="0 0 12 12" refX="10" refY="6" markerWidth="8" markerHeight="8" orient="auto"><path d="M0,0 L12,6 L0,12 z" fill="#778899"></path></marker></defs>';
  links.forEach(([a,b]) => {
    const na = nodes.find(n=>n.id===a); const nb = nodes.find(n=>n.id===b); if(!na||!nb) return;
    const x1 = na.x + na.w/2; const y1 = na.y + na.h/2;
    const x2 = nb.x + nb.w/2; const y2 = nb.y + nb.h/2;
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    // 制御点: 中央付近縦方向に少しオフセットし交差を減らす
    const midx = (x1 + x2)/2;
    const deltaY = (y2 - y1) * 0.25;
    const c1y = y1 + deltaY;
    const c2y = y2 - deltaY;
    const d = `M ${x1} ${y1} C ${midx} ${c1y} ${midx} ${c2y} ${x2} ${y2}`;
    path.setAttribute('d', d);
    path.setAttribute('stroke', '#778899');
    path.setAttribute('fill', 'transparent');
    path.setAttribute('marker-end','url(#arrow)');
    path.dataset.from = a; path.dataset.to = b;
    svg.appendChild(path);
  });
}

function selectNode(id) {
  const node = nodes.find(n=>n.id===id); if(!node) return;
  const info = document.getElementById('info');
  info.innerHTML = `<h3>${id}</h3><p>${node.label.replace(/\n/g,'<br/>')}</p>` +
    `<p><strong>API例:</strong><br/><code>${node.api.join('</code>, <code>')}</code></p>` +
    buildConnections(id);
  highlightLinks(id);
}

function buildConnections(id) {
  const outgoing = links.filter(l=>l[0]===id).map(l=>l[1]);
  const incoming = links.filter(l=>l[1]===id).map(l=>l[0]);
  return `<p><strong>接続:</strong><br/>→ ${outgoing.join(', ') || 'なし'}<br/>← ${incoming.join(', ') || 'なし'}</p>`;
}

function highlightLinks(id) {
  clearHighlight();
  const svg = document.getElementById('wires');
  [...svg.querySelectorAll('path')].forEach(p => {
    if(p.dataset.from===id || p.dataset.to===id) {
      p.classList.add('highlight');
    }
  });
  [...document.querySelectorAll('.node')].forEach(div => {
    if(div.dataset.id===id) div.style.boxShadow='0 0 0 2px var(--accent), 0 6px 16px rgba(0,0,0,.6)';
  });
}

function clearHighlight() {
  [...document.querySelectorAll('path.highlight')].forEach(p=>p.classList.remove('highlight'));
  [...document.querySelectorAll('.node')].forEach(div => { div.style.boxShadow='0 4px 12px rgba(0,0,0,.4)'; });
  document.getElementById('info').innerHTML='';
}

function buildLegend() {
  const legend = document.getElementById('legend');
  Object.entries(typeColors).forEach(([type,color]) => {
    const span = document.createElement('span');
    span.innerHTML = `<i style="background:${color}"></i>${type}`;
    legend.appendChild(span);
  });
}

window.addEventListener('load', init);
</script>
</body>
</html>